{"pageProps":{"post":{"localPath":"/home/f440/go/src/github.com/f440/f440.github.com/content/2011-12-24-superviser.markdown","path":"2011/12/24/superviser","layout":"post","title":"プロセス管理にsuperviserを使う","createdAt":"2011-12-23T15:00:00.000Z","kind":"article","comments":true,"tags":null,"content":"<p>ちょっと前にsupervisorを使ったのでやり方をまとめておく。</p>\n<!-- more -->\n<p>公式サイト: <a href=\"http://supervisord.org/\">supervisor</a></p>\n<p>supervisorはプログラムの起動、停止を管理するツール。daemontools\nがわかるなら、あんな感じのソフトだと思ってもらえれば早い。daemontoolsよりも標準的なディレクトリ構成で使えるぶん、導入障壁は低いと思う。</p>\n<p>最近のLinuxなら、パッケージですぐインストール出来る。以降の説明は debian (6.0.3)、superviser 3 系によるもの。</p>\n<h2>インストール</h2>\n<pre><code>$ sudo apt-get install superviser\n</code></pre>\n<h3>確認</h3>\n<pre><code>$ sudo service supervisor status # 起動確認（名前表示されない……）\n is running\n$ sudo service supervisor stop # 停止\nStopping supervisor: supervisord.\n$ sudo service supervisor start # 起動\nStarting supervisor: supervisord.\n</code></pre>\n<h2>例</h2>\n<p>例のために、自分のホームにインストールしてあったmemcachedを起動してみる。</p>\n<p>まずは、コマンドラインから問題無く起動出来ることを確認</p>\n<pre><code>$ /home/f440/opt/bin/memcached # 起動\n</code></pre>\n<p>プログラムはフォアグラウンドで起動する。memcached の例で言うと、-d オプション (run as a daemon) はつけない。</p>\n<p>設定ファイルを配置する。もともと /etc/supervisor/supervisord.conf 内で /etc/supervisor/conf.d/*.conf を Include するよう設定されていた読み込むように設定されていたので、以下のようなファイルを作った。</p>\n<pre><code>$ cat /etc/supervisor/conf.d/memcached.conf\n[program:memcached]\ncommand=/home/f440/opt/bin/memcached\nuser=f440\n</code></pre>\n<p>デフォルトだと設定したプログラムは自動起動する(autostart=true)なので、supervisor を再起動させれば memcachedも起動する。memcached がいつまでも起動しなければ /var/log/supervisor 以下のログを確認する。</p>\n<p>何らかの原因で停止したとき、自動起動して欲しければ autorestart=true を指定しておく。</p>\n<h2>コマンドで操作</h2>\n<p>起動中は supervisorctl 経由で操作ができるようになる。</p>\n<pre><code>$ sudo supervisor \nmemcached                        RUNNING    pid 24928, uptime 0:08:21\nsupervisor> # help でヘルプを表示\nsupervisor> exit\n$ sudo supervisor status # 直接引数を渡すこともできる\nmemcached                        RUNNING    pid 24928, uptime 0:08:21\n</code></pre>\n<h2>Webで操作</h2>\n<p>設定を追加するとWebから操作できるようになる。外部から好き放題できるので、安全な場所以外では適切な権限設定必須。</p>\n<p>ポート9001で、どこからでもアクセスできるよう設定</p>\n<pre><code>diff --git a/supervisor/supervisord.conf b/supervisor/supervisord.conf\nindex 61b3020..86e04f2 100644\n--- a/supervisor/supervisord.conf\n+++ b/supervisor/supervisord.conf\n@@ -4,6 +4,9 @@\n file=/var/run//supervisor.sock   ; (the path to the socket file)\n chmod=0700                       ; sockef file mode (default 0700)\n\n+[inet_http_server]\n+port=*:9001\n+\n [supervisord]\n logfile=/var/log/supervisor/supervisord.log ; (main log file;default $CWD/supervisord.log)\n pidfile=/var/run/supervisord.pid ; (supervisord pidfile;default supervisord.pid)\n</code></pre>\n<p>設定ファイル再読込</p>\n<pre><code> $ sudo supervisor reload\n</code></pre>\n<p>アクセス出来るようになる</p>\n<p><img src=\"/images/2011-12-24-superviser/tumblr_lx9eq9SHXa1qz5yk8.jpg\" alt=\"Web管理画面\"></p>\n<p>終わり。</p>\n"}},"__N_SSG":true}