<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><title>omnibus を使って オムニバスインストーラーを作成する - aptheia.info</title><link rel="alternate" type="application/rss+xml" title="apatheia.info" href="/atom.xml"/><meta name="next-head-count" content="4"/><link rel="preload" href="/_next/static/css/490828b4c4131e135f17.css" as="style"/><link rel="stylesheet" href="/_next/static/css/490828b4c4131e135f17.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-a40ef1678bae11e696dba45124eadd70.js"></script><script src="/_next/static/chunks/webpack-1a8a258926ecde76681b.js" defer=""></script><script src="/_next/static/chunks/framework-895f067827ebe11ffe45.js" defer=""></script><script src="/_next/static/chunks/main-a9acf05574b3448968f1.js" defer=""></script><script src="/_next/static/chunks/pages/_app-c8f1e010c17d4a8ac8e7.js" defer=""></script><script src="/_next/static/chunks/915-c287d7adb8a31cf4da35.js" defer=""></script><script src="/_next/static/chunks/pages/blog/%5B...slug%5D-c134caf83809c687960e.js" defer=""></script><script src="/_next/static/jhtzWSA_9WoQI8qF29M1i/_buildManifest.js" defer=""></script><script src="/_next/static/jhtzWSA_9WoQI8qF29M1i/_ssgManifest.js" defer=""></script></head><body><div id="__next"><header><div id="site-title"><h1><a href="/">apatheia.info</a></h1></div><nav><ul><li><a href="/">Home</a></li><li><a href="/atom.xml">RSS</a></li></ul></nav></header><main><article><h1>omnibus を使って オムニバスインストーラーを作成する</h1><p id="article-info">Published on <!-- -->2013.05.07<!-- --> <span><a href="/blog/categories/packaging/">packaging</a> </span></p><div><p>Chef のインストールは結構面倒くさかったんだけど、<a href="http://www.opscode.com/chef/install/">オムニバスインストーラー</a>が出たことで状況はがらっと変わって、簡単に導入できるようになった。このオムニバスインストーラーの仕組みは汎用的に作られているので、他のツールでも適用できるという話。</p>
<!-- more -->
<h2>オムニバスインストーラーについて</h2>
<p>Chef のオムニバスインストーラーを実行すると以下のようなディレクトリ構成でファイルが置かれる:</p>
<ul>
<li>/opt/chef/bin/ ... Chef 関連のスクリプト</li>
<li>/opt/chef/embedded/ ... ruby インタプリタ、Chef とその他依存パッケージ</li>
<li>(/usr/bin/ ... /opt/chef/bin/ 以下のものがシンボリックリンクが配置される)</li>
</ul>
<p>以上の通り、<code>/opt/chef</code> の中に動作に必要なものがごっそり置かれる。アプリケーションレベルでプログラミングの処理系を持っちゃうというのはこれに限らずよく見る光景で、理由としてはパッケージ提供されていない最新版が使いたかったり、バージョンアップやライブラリインストールの影響範囲を限定させたかったりだと思う。</p>
<p>ここしばらくは手軽なパッケージ作成ツールとして<a href="https://github.com/jordansissel/fpm">fpm</a>がよく使われているけど、オムニバスインストーラーは<a href="https://github.com/opscode/omnibus-ruby">omnibus</a>という「ビルドツール」＋「fpm ラッパー」といった感じのもので作られている。以下は実際に <a href="https://github.com/opscode/omnibus-ruby">omnibus</a> を使ったインストーラー作成の手順についてまとめる。</p>
<h2>パッケージ作成</h2>
<p><a href="https://github.com/etsy/statsd">statsd</a> および <a href="https://github.com/etsy/statsd">statsd</a> を動かすために必要な Node.js を /opt/statsd にインストールする RPM, Deb パッケージの作成を行ってみる。</p>
<h3>環境</h3>
<ul>
<li>Macbook Air Mountain Lion</li>
<li>Ruby 2.0.0-p0</li>
<li>Vagrant 1.2.2</li>
</ul>
<h3>手順</h3>
<pre><code># omnibus のインストール
gem install omnibus

# 必要となる vagrant 用の plugin をインストール
vagrant plugin install vagrant-omnibus
vagrant plugin install vagrant-berkshelf

# プロジェクトディレクトリの作成(ディレクトリ名は `omnibus-プロジェクト` となる)
omnibus project statsd
cd omnibus-statsd

# プロジェクトディレクトリ内のファイルを適宜修正:
    Berksfile
      Berkshelf 用の設定。変更する必要無い。
    Vagrantfile
      Vagrant 用の設定。2013-06-07 現在だと CentOS 5, 6 Ubuntu 10.04, 11.04, 12.04 の設定が導入済み。
    README.md
    omnibus.rb.example
      成果物を S3 上にキャッシュする場合などに利用。使わないなら気にしなくていい。
    config/projects/statsd.rb
      後述
    config/software/*
      後述
    package-scripts/statsd/*
      インストール時、アンインストール時などに実行したいスクリプトなど。
</code></pre>
<p>この中で、実際のビルドプロセスを定義するのは、config/projects/ 以下と config/software 以下になる。</p>
<p><code>config/projects/</code> はプロジェクトの設定を格納するディレクトリで、初期状態では statsd 用のプロジェクトファイル <code>config/projects/statsd.rb</code> が作られている。このファイルを修正していくことになる。</p>
<pre><code>name "statsd"
maintainer "f440"
homepage "https://github.com/f440/omnibus-statsd"

install_path    "/opt/statsd"
build_version   "0.6.0"
build_iteration 1

dependency "preparation"
dependency "node"
dependency "statsd"

exclude "\.git*"
</code></pre>
<p>おおむね想像がつく名前だけど、dependency だけはよく分からないと思う。dependency で指定したものはプロジェクトを構成する software という扱いで、<code>config/software/</code> 以下でその設定を行っていく。</p>
<p>software の例を示す。典型的な例だと、指定した URL からダウンロードしてきたものを一時ディレクトリで展開して、<code>configure &#x26;&#x26; make &#x26;&#x26; make install</code> を実行、などだが今回の作業では Node.js のバイナリを展開して <code>/opt/embedded</code> 以下にコピーしているだけである。</p>
<pre><code>name "node"
version "0.10.5"

source :url => "http://nodejs.org/dist/v0.10.5/node-v0.10.5-linux-x64.tar.gz",
       :md5 => "fb65723d395c559393201dd41e0eb275"

relative_path "node-v0.10.5-linux-x64"

build do
  command "rsync -av . #{install_dir}/embedded/"
end
</code></pre>
<p>必要となる software の設定を全部そろえたらビルドを実行する。マシンの起動、Chef のインストール、omnibus の Cookbook 実行、ビルド環境構築、ビルド実行、パッケージ作成 といったことが行われることになるため、初回はかなり待つことになる。</p>
<pre><code>vagrant up
(vagrant up centos-6 など、直接マシンを指定してもいい)
(もし Linux 上で作業しているのであれば、omnibus build project statsd で直接パッケージ作成を開始出来る)
</code></pre>
<p>問題なければ、pkg/ 以下に statsd-0.6.0-1.el6.x86_64.rpm, statsd_0.6.0-1.ubuntu.12.04_amd64.deb といったファイルが出来る。</p>
<h2>まとめ</h2>
<p>やっていることは <a href="https://github.com/jordansissel/fpm">fpm</a> でパッケージを作っているだけなんだけど、<a href="http://www.vagrantup.com/">Vagrant</a> x <a href="http://berkshelf.com/">Berkshelf</a> x <a href="http://www.opscode.com/chef/">Chef</a> のコンビネーションのおかげで、パッケージとそのパッケージを作るための環境が簡単に手に入るのはとてもいい。複数環境のパッケージを作る予定がなくっても、最初から<a href="https://github.com/opscode/omnibus-ruby">omnibus</a>上でパッケージを作れるようにしておくと運用が楽そう。</p>
<h2>備考</h2>
<p>似たようなツールとして、<a href="https://github.com/joemiller/bunchr">bunchr</a> が存在する。</p>
<h2>参考</h2>
<ul>
<li><a href="https://github.com/etsy/statsd">Statsd</a></li>
<li><a href="http://www.opscode.com/chef/install/">Install Chef</a></li>
<li><a href="https://github.com/opscode/omnibus-ruby">omnibus</a></li>
<li><a href="https://github.com/joemiller/bunchr">bunchr</a></li>
<li><a href="https://github.com/jordansissel/fpm">fpm</a></li>
<li><a href="http://www.vagrantup.com/">Vagrant</a></li>
<li><a href="http://berkshelf.com/">Berkshelf</a></li>
</ul>
</div></article></main><footer><ul><li>Link:</li><li><a href="https://twitter.com/f440">Twitter</a></li><li><a href="https://github.com/f440">Github</a></li><li><a href="https://pinbaord.in/u:f440">Pinbaord</a></li></ul></footer></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"localPath":"/home/f440/go/src/github.com/f440/f440.github.com/content/2013-05-07-create-ominibus-installer.markdown","path":"2013/05/07/create-ominibus-installer","layout":"post","title":"omnibus を使って オムニバスインストーラーを作成する","createdAt":"2013-05-06T16:41:00.000Z","kind":"article","comments":true,"tags":["packaging"],"content":"\u003cp\u003eChef のインストールは結構面倒くさかったんだけど、\u003ca href=\"http://www.opscode.com/chef/install/\"\u003eオムニバスインストーラー\u003c/a\u003eが出たことで状況はがらっと変わって、簡単に導入できるようになった。このオムニバスインストーラーの仕組みは汎用的に作られているので、他のツールでも適用できるという話。\u003c/p\u003e\n\u003c!-- more --\u003e\n\u003ch2\u003eオムニバスインストーラーについて\u003c/h2\u003e\n\u003cp\u003eChef のオムニバスインストーラーを実行すると以下のようなディレクトリ構成でファイルが置かれる:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e/opt/chef/bin/ ... Chef 関連のスクリプト\u003c/li\u003e\n\u003cli\u003e/opt/chef/embedded/ ... ruby インタプリタ、Chef とその他依存パッケージ\u003c/li\u003e\n\u003cli\u003e(/usr/bin/ ... /opt/chef/bin/ 以下のものがシンボリックリンクが配置される)\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e以上の通り、\u003ccode\u003e/opt/chef\u003c/code\u003e の中に動作に必要なものがごっそり置かれる。アプリケーションレベルでプログラミングの処理系を持っちゃうというのはこれに限らずよく見る光景で、理由としてはパッケージ提供されていない最新版が使いたかったり、バージョンアップやライブラリインストールの影響範囲を限定させたかったりだと思う。\u003c/p\u003e\n\u003cp\u003eここしばらくは手軽なパッケージ作成ツールとして\u003ca href=\"https://github.com/jordansissel/fpm\"\u003efpm\u003c/a\u003eがよく使われているけど、オムニバスインストーラーは\u003ca href=\"https://github.com/opscode/omnibus-ruby\"\u003eomnibus\u003c/a\u003eという「ビルドツール」＋「fpm ラッパー」といった感じのもので作られている。以下は実際に \u003ca href=\"https://github.com/opscode/omnibus-ruby\"\u003eomnibus\u003c/a\u003e を使ったインストーラー作成の手順についてまとめる。\u003c/p\u003e\n\u003ch2\u003eパッケージ作成\u003c/h2\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/etsy/statsd\"\u003estatsd\u003c/a\u003e および \u003ca href=\"https://github.com/etsy/statsd\"\u003estatsd\u003c/a\u003e を動かすために必要な Node.js を /opt/statsd にインストールする RPM, Deb パッケージの作成を行ってみる。\u003c/p\u003e\n\u003ch3\u003e環境\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003eMacbook Air Mountain Lion\u003c/li\u003e\n\u003cli\u003eRuby 2.0.0-p0\u003c/li\u003e\n\u003cli\u003eVagrant 1.2.2\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3\u003e手順\u003c/h3\u003e\n\u003cpre\u003e\u003ccode\u003e# omnibus のインストール\ngem install omnibus\n\n# 必要となる vagrant 用の plugin をインストール\nvagrant plugin install vagrant-omnibus\nvagrant plugin install vagrant-berkshelf\n\n# プロジェクトディレクトリの作成(ディレクトリ名は `omnibus-プロジェクト` となる)\nomnibus project statsd\ncd omnibus-statsd\n\n# プロジェクトディレクトリ内のファイルを適宜修正:\n    Berksfile\n      Berkshelf 用の設定。変更する必要無い。\n    Vagrantfile\n      Vagrant 用の設定。2013-06-07 現在だと CentOS 5, 6 Ubuntu 10.04, 11.04, 12.04 の設定が導入済み。\n    README.md\n    omnibus.rb.example\n      成果物を S3 上にキャッシュする場合などに利用。使わないなら気にしなくていい。\n    config/projects/statsd.rb\n      後述\n    config/software/*\n      後述\n    package-scripts/statsd/*\n      インストール時、アンインストール時などに実行したいスクリプトなど。\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eこの中で、実際のビルドプロセスを定義するのは、config/projects/ 以下と config/software 以下になる。\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003econfig/projects/\u003c/code\u003e はプロジェクトの設定を格納するディレクトリで、初期状態では statsd 用のプロジェクトファイル \u003ccode\u003econfig/projects/statsd.rb\u003c/code\u003e が作られている。このファイルを修正していくことになる。\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003ename \"statsd\"\nmaintainer \"f440\"\nhomepage \"https://github.com/f440/omnibus-statsd\"\n\ninstall_path    \"/opt/statsd\"\nbuild_version   \"0.6.0\"\nbuild_iteration 1\n\ndependency \"preparation\"\ndependency \"node\"\ndependency \"statsd\"\n\nexclude \"\\.git*\"\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eおおむね想像がつく名前だけど、dependency だけはよく分からないと思う。dependency で指定したものはプロジェクトを構成する software という扱いで、\u003ccode\u003econfig/software/\u003c/code\u003e 以下でその設定を行っていく。\u003c/p\u003e\n\u003cp\u003esoftware の例を示す。典型的な例だと、指定した URL からダウンロードしてきたものを一時ディレクトリで展開して、\u003ccode\u003econfigure \u0026#x26;\u0026#x26; make \u0026#x26;\u0026#x26; make install\u003c/code\u003e を実行、などだが今回の作業では Node.js のバイナリを展開して \u003ccode\u003e/opt/embedded\u003c/code\u003e 以下にコピーしているだけである。\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003ename \"node\"\nversion \"0.10.5\"\n\nsource :url =\u003e \"http://nodejs.org/dist/v0.10.5/node-v0.10.5-linux-x64.tar.gz\",\n       :md5 =\u003e \"fb65723d395c559393201dd41e0eb275\"\n\nrelative_path \"node-v0.10.5-linux-x64\"\n\nbuild do\n  command \"rsync -av . #{install_dir}/embedded/\"\nend\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e必要となる software の設定を全部そろえたらビルドを実行する。マシンの起動、Chef のインストール、omnibus の Cookbook 実行、ビルド環境構築、ビルド実行、パッケージ作成 といったことが行われることになるため、初回はかなり待つことになる。\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003evagrant up\n(vagrant up centos-6 など、直接マシンを指定してもいい)\n(もし Linux 上で作業しているのであれば、omnibus build project statsd で直接パッケージ作成を開始出来る)\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e問題なければ、pkg/ 以下に statsd-0.6.0-1.el6.x86_64.rpm, statsd_0.6.0-1.ubuntu.12.04_amd64.deb といったファイルが出来る。\u003c/p\u003e\n\u003ch2\u003eまとめ\u003c/h2\u003e\n\u003cp\u003eやっていることは \u003ca href=\"https://github.com/jordansissel/fpm\"\u003efpm\u003c/a\u003e でパッケージを作っているだけなんだけど、\u003ca href=\"http://www.vagrantup.com/\"\u003eVagrant\u003c/a\u003e x \u003ca href=\"http://berkshelf.com/\"\u003eBerkshelf\u003c/a\u003e x \u003ca href=\"http://www.opscode.com/chef/\"\u003eChef\u003c/a\u003e のコンビネーションのおかげで、パッケージとそのパッケージを作るための環境が簡単に手に入るのはとてもいい。複数環境のパッケージを作る予定がなくっても、最初から\u003ca href=\"https://github.com/opscode/omnibus-ruby\"\u003eomnibus\u003c/a\u003e上でパッケージを作れるようにしておくと運用が楽そう。\u003c/p\u003e\n\u003ch2\u003e備考\u003c/h2\u003e\n\u003cp\u003e似たようなツールとして、\u003ca href=\"https://github.com/joemiller/bunchr\"\u003ebunchr\u003c/a\u003e が存在する。\u003c/p\u003e\n\u003ch2\u003e参考\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/etsy/statsd\"\u003eStatsd\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"http://www.opscode.com/chef/install/\"\u003eInstall Chef\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/opscode/omnibus-ruby\"\u003eomnibus\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/joemiller/bunchr\"\u003ebunchr\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/jordansissel/fpm\"\u003efpm\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"http://www.vagrantup.com/\"\u003eVagrant\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"http://berkshelf.com/\"\u003eBerkshelf\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n"}},"__N_SSG":true},"page":"/blog/[...slug]","query":{"slug":["2013","05","07","create-ominibus-installer"]},"buildId":"jhtzWSA_9WoQI8qF29M1i","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>