<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><title>roundsmanを使ってcapistranoからchef-soloを実行する - aptheia.info</title><link rel="alternate" type="application/rss+xml" title="apatheia.info" href="/atom.xml"/><meta name="next-head-count" content="4"/><link rel="preload" href="/_next/static/css/3c128f59c2ecef969dbc.css" as="style"/><link rel="stylesheet" href="/_next/static/css/3c128f59c2ecef969dbc.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-a40ef1678bae11e696dba45124eadd70.js"></script><script src="/_next/static/chunks/webpack-1a8a258926ecde76681b.js" defer=""></script><script src="/_next/static/chunks/framework-895f067827ebe11ffe45.js" defer=""></script><script src="/_next/static/chunks/main-a9acf05574b3448968f1.js" defer=""></script><script src="/_next/static/chunks/pages/_app-d96712b144c157b4cbfa.js" defer=""></script><script src="/_next/static/chunks/915-c287d7adb8a31cf4da35.js" defer=""></script><script src="/_next/static/chunks/pages/blog/%5B...slug%5D-c134caf83809c687960e.js" defer=""></script><script src="/_next/static/DRRa5gyB7gBKf8n1UmP3L/_buildManifest.js" defer=""></script><script src="/_next/static/DRRa5gyB7gBKf8n1UmP3L/_ssgManifest.js" defer=""></script></head><body><div id="__next"><header><div id="site-title"><h1><a href="/">apatheia.info</a></h1></div><nav><ul><li><a href="/">Home</a></li><li><a href="/atom.xml">RSS</a></li></ul></nav></header><main><article><h1>roundsmanを使ってcapistranoからchef-soloを実行する</h1><p id="article-info">Published on <!-- -->2012.07.30<!-- --> </p><div><p>管理対象のサーバー台数が少ない場合など、<a href="http://www.opscode.com/chef/">chef</a>のサーバーを運用するコストとベネフィットを天秤にかけてみて、ああこれどう考えても労力ペイできないな、でも設定ファイルを手動で管理するのはやだな、といったときに[roundsman](https://g
ithub.com/iain/roundsman)を使うといいという話。</p>
<!-- more -->
<p><a href="https://github.com/iain/roundsman">roundsman</a>は、chefのレシピを転送して<a href="http://wiki.opscode.com/display/chef/Chef+Solo">chef-solo</a>を実行する<a href="https://github.com/capistrano/capistrano">capistrano</a>向けライブラリ。アプリケーションのリリースタイミングに併せてインフラ設定の変更が必要になることは往々にしてあるので、<a href="https://github.com/capistrano/capistrano">capistrano</a>を使ってデプロイとインフラ設定変更を一括適
用できるのは便利だ。</p>
<p>ここでは、Railsアプリを対象に<a href="https://github.com/iain/roundsman">roundsman</a>適用までの作業を簡単にまとめる。</p>
<h2>手順</h2>
<p>まずは適当なRailsプロジェクトを作るところから。</p>
<pre><code>PROJECT="my_fantastic_project"
rails new $PROJECT
cd $PROJECT

$EDITOR Gemfile
  # 追加
  gem roundsman, :require => false
  gem capistrano, :require => false

bundle install --path vendor/bundle

# capistranoのCapfile、config/deploy.rbを生成
bundle exec capify .
</code></pre>
<p>chefのcookbooksは<code>config/cookbooks</code>に配置する。場所は設定で変更可能。このディレクトリだけ別リポジトリにしておくと、ほかのプロジェクトでも転用できて便利なのでそうしてる。</p>
<p>config/deploy.rbを調整する。サーバーの種別ごとにデプロイを切り替えたいので、マルチステージを有効化。</p>
<pre><code>$EDITOR config/deploy.rb

# 追加
# require roundsman/capistrano
# require capistrano/ext/multistage
</code></pre>
<p>サーバーグループの設定を<code>config/deploy/*.rb</code>に配置。これについては、[capistrano/ext/multistage](https:
//github.com/capistrano/capistrano/wiki/2.x-Multistage-Extension)の説明を参照。</p>
<p>あとは<code>config/deploy.rb</code>でrecipeを実行するタスクを追加し、<code>config/deploy/*.rb</code>の中でattributeを設定していく。</p>
<pre><code>config/deploy.rb:

    namespace :chef do
      set :care_about_ruby_version, false

      # 一括して適用
      task :default do
        roundsman.run_list fetch(:run_list)
      end

      # 個別にレシピ適用 (ex. nginx)
        namespace :nginx do
          task :install do
            roundsman.run_list "recipe[nginx]"
          end
        end

      end
</code></pre>
<p><a href="https://github.com/iain/roundsman#configuration">githubにある設定方法の説明</a>だと、config/ステージ名.rb に設定を書いている。</p>
<pre><code>config/deploy/*.rb:

    set :nginx, :user => "nginx", "worker_process" => 1, …
    set :run_recipe, :user => "nginx", "worker_process" => 1, …
</code></pre>
<p>ただ、これだとattributesの管理がcapistranoの中にべったり書くことになってしまい、chef-soloを手で実行したいときとか面倒くさい。そのため、attributesの値はknifeやchef-
soloで読めるようなjsonを作って、config/roles 以下で管理している。</p>
<p>roles ディレクトリはアプリのアップデートと関係なく更新していくことになるので、別リポジトリで管理した方がいい。</p>
<pre><code>ファイル構成(抜粋)

  ├── Capify
  ├── Gemfile
  └── config
        ├── cookbooks
        ├── deploy
        └── roles

config/deploy.rb:

  # jsonファイルを取り込む関数を追加
  require active_support/core_ext/hash/deep_merge
  def load_role(*roles)
    json = {}
    roles.each do |role|
      json_path = "#{File.dirname(__FILE__)}/roles/#{role}.json"
      json.deep_merge! JSON.load(File.new(json_path))
    end
    json.each {|k,v| set (k.to_sym), v }
 end

config/deploy/*.rb:

  # 読み込みたいjsonファイルを指定
  load_role "web"

config/roles/*.json:

 例: config/roles/web.json
  {
     "nginx" : {
      "user" : "nginx",
      "worker_processes" : 1,
    …
     "run_list" : [ "recipe[nginx]", ... ]
  }
</code></pre>
<p>以上で準備が整った。これで実行できるようになる。</p>
<pre><code># 一括適用
bundle exec cap ステージ名 chef

# cookbook を指定して適用
bundle exec cap ステージ名 chef:nginx
</code></pre>
</div></article></main><footer><ul><li>Link:</li><li><a href="https://twitter.com/f440">Twitter</a></li><li><a href="https://github.com/f440">Github</a></li><li><a href="https://pinbaord.in/u:f440">Pinbaord</a></li></ul></footer></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"localPath":"/home/f440/go/src/github.com/f440/f440.github.com/content/2012-07-30-roundsman-capistrano-chef-solo.markdown","path":"2012/07/30/roundsman-capistrano-chef-solo","layout":"post","title":"roundsmanを使ってcapistranoからchef-soloを実行する","createdAt":"2012-07-29T15:00:00.000Z","kind":"article","comments":true,"tags":null,"content":"\u003cp\u003e管理対象のサーバー台数が少ない場合など、\u003ca href=\"http://www.opscode.com/chef/\"\u003echef\u003c/a\u003eのサーバーを運用するコストとベネフィットを天秤にかけてみて、ああこれどう考えても労力ペイできないな、でも設定ファイルを手動で管理するのはやだな、といったときに[roundsman](https://g\nithub.com/iain/roundsman)を使うといいという話。\u003c/p\u003e\n\u003c!-- more --\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/iain/roundsman\"\u003eroundsman\u003c/a\u003eは、chefのレシピを転送して\u003ca href=\"http://wiki.opscode.com/display/chef/Chef+Solo\"\u003echef-solo\u003c/a\u003eを実行する\u003ca href=\"https://github.com/capistrano/capistrano\"\u003ecapistrano\u003c/a\u003e向けライブラリ。アプリケーションのリリースタイミングに併せてインフラ設定の変更が必要になることは往々にしてあるので、\u003ca href=\"https://github.com/capistrano/capistrano\"\u003ecapistrano\u003c/a\u003eを使ってデプロイとインフラ設定変更を一括適\n用できるのは便利だ。\u003c/p\u003e\n\u003cp\u003eここでは、Railsアプリを対象に\u003ca href=\"https://github.com/iain/roundsman\"\u003eroundsman\u003c/a\u003e適用までの作業を簡単にまとめる。\u003c/p\u003e\n\u003ch2\u003e手順\u003c/h2\u003e\n\u003cp\u003eまずは適当なRailsプロジェクトを作るところから。\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003ePROJECT=\"my_fantastic_project\"\nrails new $PROJECT\ncd $PROJECT\n\n$EDITOR Gemfile\n  # 追加\n  gem roundsman, :require =\u003e false\n  gem capistrano, :require =\u003e false\n\nbundle install --path vendor/bundle\n\n# capistranoのCapfile、config/deploy.rbを生成\nbundle exec capify .\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003echefのcookbooksは\u003ccode\u003econfig/cookbooks\u003c/code\u003eに配置する。場所は設定で変更可能。このディレクトリだけ別リポジトリにしておくと、ほかのプロジェクトでも転用できて便利なのでそうしてる。\u003c/p\u003e\n\u003cp\u003econfig/deploy.rbを調整する。サーバーの種別ごとにデプロイを切り替えたいので、マルチステージを有効化。\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e$EDITOR config/deploy.rb\n\n# 追加\n# require roundsman/capistrano\n# require capistrano/ext/multistage\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eサーバーグループの設定を\u003ccode\u003econfig/deploy/*.rb\u003c/code\u003eに配置。これについては、[capistrano/ext/multistage](https:\n//github.com/capistrano/capistrano/wiki/2.x-Multistage-Extension)の説明を参照。\u003c/p\u003e\n\u003cp\u003eあとは\u003ccode\u003econfig/deploy.rb\u003c/code\u003eでrecipeを実行するタスクを追加し、\u003ccode\u003econfig/deploy/*.rb\u003c/code\u003eの中でattributeを設定していく。\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003econfig/deploy.rb:\n\n    namespace :chef do\n      set :care_about_ruby_version, false\n\n      # 一括して適用\n      task :default do\n        roundsman.run_list fetch(:run_list)\n      end\n\n      # 個別にレシピ適用 (ex. nginx)\n        namespace :nginx do\n          task :install do\n            roundsman.run_list \"recipe[nginx]\"\n          end\n        end\n\n      end\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/iain/roundsman#configuration\"\u003egithubにある設定方法の説明\u003c/a\u003eだと、config/ステージ名.rb に設定を書いている。\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003econfig/deploy/*.rb:\n\n    set :nginx, :user =\u003e \"nginx\", \"worker_process\" =\u003e 1, …\n    set :run_recipe, :user =\u003e \"nginx\", \"worker_process\" =\u003e 1, …\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eただ、これだとattributesの管理がcapistranoの中にべったり書くことになってしまい、chef-soloを手で実行したいときとか面倒くさい。そのため、attributesの値はknifeやchef-\nsoloで読めるようなjsonを作って、config/roles 以下で管理している。\u003c/p\u003e\n\u003cp\u003eroles ディレクトリはアプリのアップデートと関係なく更新していくことになるので、別リポジトリで管理した方がいい。\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003eファイル構成(抜粋)\n\n  ├── Capify\n  ├── Gemfile\n  └── config\n        ├── cookbooks\n        ├── deploy\n        └── roles\n\nconfig/deploy.rb:\n\n  # jsonファイルを取り込む関数を追加\n  require active_support/core_ext/hash/deep_merge\n  def load_role(*roles)\n    json = {}\n    roles.each do |role|\n      json_path = \"#{File.dirname(__FILE__)}/roles/#{role}.json\"\n      json.deep_merge! JSON.load(File.new(json_path))\n    end\n    json.each {|k,v| set (k.to_sym), v }\n end\n\nconfig/deploy/*.rb:\n\n  # 読み込みたいjsonファイルを指定\n  load_role \"web\"\n\nconfig/roles/*.json:\n\n 例: config/roles/web.json\n  {\n     \"nginx\" : {\n      \"user\" : \"nginx\",\n      \"worker_processes\" : 1,\n    …\n     \"run_list\" : [ \"recipe[nginx]\", ... ]\n  }\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e以上で準備が整った。これで実行できるようになる。\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e# 一括適用\nbundle exec cap ステージ名 chef\n\n# cookbook を指定して適用\nbundle exec cap ステージ名 chef:nginx\n\u003c/code\u003e\u003c/pre\u003e\n"}},"__N_SSG":true},"page":"/blog/[...slug]","query":{"slug":["2012","07","30","roundsman-capistrano-chef-solo"]},"buildId":"DRRa5gyB7gBKf8n1UmP3L","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>