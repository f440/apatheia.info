<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><title>tagged cm - aptheia.info</title><link rel="alternate" type="application/rss+xml" title="apatheia.info" href="/atom.xml"/><meta name="next-head-count" content="4"/><link rel="preload" href="/_next/static/css/490828b4c4131e135f17.css" as="style"/><link rel="stylesheet" href="/_next/static/css/490828b4c4131e135f17.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-a40ef1678bae11e696dba45124eadd70.js"></script><script src="/_next/static/chunks/webpack-1a8a258926ecde76681b.js" defer=""></script><script src="/_next/static/chunks/framework-895f067827ebe11ffe45.js" defer=""></script><script src="/_next/static/chunks/main-a9acf05574b3448968f1.js" defer=""></script><script src="/_next/static/chunks/pages/_app-c8f1e010c17d4a8ac8e7.js" defer=""></script><script src="/_next/static/chunks/915-c287d7adb8a31cf4da35.js" defer=""></script><script src="/_next/static/chunks/pages/blog/categories/%5Btag%5D-c38c66d576a52b73b44b.js" defer=""></script><script src="/_next/static/jhtzWSA_9WoQI8qF29M1i/_buildManifest.js" defer=""></script><script src="/_next/static/jhtzWSA_9WoQI8qF29M1i/_ssgManifest.js" defer=""></script></head><body><div id="__next"><header><div id="site-title"><h1><a href="/">apatheia.info</a></h1></div><nav><ul><li><a href="/">Home</a></li><li><a href="/atom.xml">RSS</a></li></ul></nav></header><main><article><h1>Articles tagged &#x27;<!-- -->cm<!-- -->&#x27;</h1><section style="margin-bottom:1em"><h2><a href="/blog/2013/04/06/about-ansible/">構成管理ツール Ansible について</a></h2><span>2013.04.06</span> <span><a href="/blog/categories/cm/">cm</a> </span></section></article></main><footer><ul><li>Link:</li><li><a href="https://twitter.com/f440">Twitter</a></li><li><a href="https://github.com/f440">Github</a></li><li><a href="https://pinbaord.in/u:f440">Pinbaord</a></li></ul></footer></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"tag":"cm","posts":[{"localPath":"/home/f440/go/src/github.com/f440/f440.github.com/content/2013-04-06-about-ansible.markdown","path":"blog/2013/04/06/about-ansible","layout":"post","title":"構成管理ツール Ansible について","createdAt":"2013-04-06T05:50:00.000Z","kind":"article","comments":true,"tags":["cm"],"content":"\n[Ansible] というサーバーの設定を管理するツールの説明。いわゆる構成管理 (CM: Configuration Management) にカテゴライズされるもので、Puppet や Chef の親戚みたいなものと考えてもらえればだいたいあってる。\n\n\u003c!-- more --\u003e\n\n## 概要\n\nリード開発者は Michael DeHaan で、現職の AnsibleWorks の前は Redhat で [Cobbler] や [Func] に携わっていたり、Puppet labs でプロダクトマネージャーしたりしているという経歴の持ち主。\n\nAnsible は Python で書かれている。同じジャンルで Python 製というと [Salt] が有名。Chef の場合、レシピを書くためには Ruby の知識が必要となってくるけど、Ansible はどんな言語でもモジュールが書けるようになっているので、運用にあたって Python の知識は必要無い。\n\n動作の点でも Puppet や Chef などのツールとまったく異なるアプローチをしている。Puppet や Chef は、サーバーとクライアントで構成され、クライアントとなるマシンはサーバーに設定を問い合わせながら、自分自身を「あるべき状態」に収束するよう変更を加えていく。Ansible の場合、サーバー側からクライアントとなるサーバー(群)に対して直接命令を送り込み結果を得る。これは [Func]、[Capistrano]、[Fabric] などに似ているが、これらのデプロイを目的としたツールにはない「何回やっても結果が同じ」(idempotence) という CM ツールらしさはちゃんと備えている。\n\nドキュメントは12ページしかなく(ちなみに、さっき数えてみたらChefのドキュメントは2834ファイルあった) 非常に習得は簡単。サーバーを立てる必要もなく、クライアントマシンもエージェントレス、加えて短期間で学習できるので手軽感は非常に高いが、モジュール機構が強力なのできわめて実用的になっている。\n\n\n\n## 基本的な概念\n\nAnsible を理解する上で重要となる、モジュールとプレーブックについて説明する。\n\n### モジュール\n\nクライアント内での動きはモジュールという形で定義する。\n\nパッケージのインストール、サービスの起動、ユーザーやグループの作成などの基本的なモジュールはあるが、実際には環境に合わせて不足分は自分でモジュールを作っていくことになる。\n\nモジュールは簡単に作れる。モジュールが役割を端的に言うと、以下を行うだけである。\n\n- 標準入力でオプションを受け取る\n- 標準出力で実行結果を返す\n\n  - 出力形式は key=value を空白でつなげたものか JSON\n\nこれができる言語であれば、シェルスクリプトでも Perl でも問題ない。\n\n### プレーブック\n\n実際の処理では単発のモジュールでサーバーの設定が終わることはないので、モジュールの使い方をまとめたものが必要になる。Ansible では、YAML で処理をまとめたものを プレーブック (Playbook)と呼んでいる。\n\n例: Apache と PHP をインストールする (webapp.yml)\n\n    - hosts: webserver\n      user: vagrant\n      sudo: yes\n      tasks:\n        - name: install apache\n          action: yum pkg=httpd state=installed\n        - name: install php\n          action: yum pkg=php state=installed\n\n例: 実行\n\n    # ansible-playbook プレーブック名\n    $ ansible-playbook webapp.yml\n\n以上は簡単な例だが、設定ファイルを配置したり、それに併せてサービスを再起動させたりといったことも記述可能。\n\nプレーブックには以下のような内容が含まれる:\n\n- hosts: 対象のホスト\n- user: 実行ユーザー\n- vars: 変数\n- tasks: タスク\n\n`vars` の変数は、テンプレート内で展開される。設定ファイル配置時にパラメータを変更、といった場合に利用する。\n\n### インストール\n\n以下では、インストールから簡単なコマンドの実行までの例を挙げる。サーバー、クライアント双方で CentOS 6.4 を利用した。\n\nAnsible を動かすためには、Python 2.6 以上と Ansible のソースコードとごくわずかな Python パッケージだけあればよい。CentOS 6 であれば Python の条件は満たせているし、EPEL で Ansible のパッケージが提供されているので、`yum` でインストール可能。\n\n    # EPEL 有効化\n    $ sudo rpm -ivh http://ftp.riken.jp/Linux/fedora/epel/6/i386/epel-release-6-8.noarch.rpm\n\n    # Ansible インストール\n    $ sudo yum install ansible\n\n他の Unix 系OSであれば、`pip install ansible` でいい。\n\n    $ sudo pip install ansible\n\n次に、サーバーからクライアントに SSH でログインできるように調整しておく。\n\n    # 以下のマシンを用意した。\n    # それぞれホスト名でアクセスできる\n    #    Ansible 実行側 ... server\n    #    変更対象 ... client1, client2\n\n    # server側で公開鍵認証用の鍵を作成\n    $ $ ssh-keygen -t rsa\n\n    # client に公開鍵を配置する\n    $ ssh-copy-id client1\n    $ ssh-copy-id client2\n\n    # 試しにログインしてみる\n    # 頻繁に実行することになるので、公開鍵にパスフレーズを\n    # 設定している場合は、ssh-agent を使ってパスフレーズの\n    # 入力を省略できるようにしておく。\n    $ ssh client1\n    $ ssh client2\n\n今度は、対象のサーバーを設定してみよう。環境変数 `ANSIBLE_HOSTS` にあるファイルでサーバーの指定が可能。\n\n    $ cat \u003cEOD \u003e~/target\n    \u003e [webserver]\n    \u003e client1\n    \u003e \n    \u003e [dbserver]\n    \u003e client2\n    \u003e EOD\n    $ export ANSIBLE_HOSTS=~/target\n\n設定の中で、`[ ]` によりグループを作っている。つまり「webserver グループに client1、dbserver グループに client2 が所属している」ということを表している。グループはオプションなので、単純にホスト名を羅列するだけでもいい。試しに、対象のホストを調べてみよう。\n\n    # ansible ホストパターン --list-hosts\n\n    # ホスト名を直接指定\n    $ ansible client1 --list-hosts\n    client1\n\n    # グループ名を指定\n    $ ansible webserver --list-hosts\n    client1\n    $ ansible dbserver --list-hosts\n    client2\n\n    # all を指定した場合、全サーバーを列挙\n    $ ansible all --list-hosts\n    client1\n    client2\n\nこれだけで準備は完了。実行してみる。\n\n    # コマンドの書式\n    ansible 対象 -m モジュール名 -a オプション\n\n    # 例 ping モジュール\n    $ ansible all -m ping\n    client2 | success \u003e\u003e {\n        \"changed\": false,\n        \"ping\": \"pong\"\n    }\n    \n    client1 | success \u003e\u003e {\n        \"changed\": false,\n        \"ping\": \"pong\"\n    }\n\n`-m` をつけないで、直接コマンドを実行することも可能。\n\n    # すべてのマシンでカーネルのバージョンを取得\n    $ ansible all -a 'uname -r'\n    client2 | success | rc=0 \u003e\u003e\n    2.6.32-358.el6.x86_64\n    \n    client1 | success | rc=0 \u003e\u003e\n    2.6.32-358.el6.x86_64\n\nプレーブックを実行したときは以下のようになる。\n\n    # 対象は webserver というグループ(client1 が所属)に対して、\n    # Apache と PHP をインストールするプレーブック、webapp.yml を実行\n    # Apache はすでにインストールされていたので、\n    # PHP のみインストールされることとなった\n\n    $ ansible-playbook webapp.yml\n    \n    PLAY [webserver] *********************\n    \n    GATHERING FACTS *********************\n    ok: [client1]\n    \n    TASK: [install apache] *********************\n    ok: [client1]\n    \n    TASK: [install php] *********************\n    changed: [client1]\n    \n    PLAY RECAP *********************\n    client1                        : ok=3    changed=1    unreachable=0    failed=0\n\n\n## その他\n\n- [Vagrant もバージョン 1.2 から Ansible でのプロビジョニングをサポート予定][vagrant ansible support]\n- 開発は活発\n- リリース名がヴァンヘイレンの曲名 (1.0 は Eruptionだった)\n- ロゴがださい (ML でも 90年代のデザインなんて言われている)\n\n## まとめ\n\nロゴのセンスは悪いけど、アプリケーション自体の仕組みはすごくセンスがいい。\n\n他の構成管理ツールと比べると、DSL を覚えるといった「ツールを使うまでののコスト」、ツールのためのサーバー構築・運用といった「ツールを使ってからのコスト」が軽微なので、よりやりたいことに目が向けられるのもうれしい。\n\n最近日本国内でも Chef の話題を聞くことが多いんだけど、Chef Server の運用とかオートスケールとのコンビネーションとかの情報はあまり聞かないので、たぶん割と小規模な環境でリモートサーバーの Chef-solo をキックみたいなケースが多いのかと思う。そういったところだと、Ansible のほうがふさわしいっていうことが多いんじゃないかな。\n\n[Ansible]: http://ansible.cc/\n[Github]: https://github.com/ansible\n[Salt]: http://saltstack.com/\n[Cobbler]: http://cobbler.github.io/\n[Func]: https://fedorahosted.org/func/\n[Fabric]: http://fabfile.org/\n[Capistrano]: http://capistranorb.com/\n[vagrant ansible support]: https://twitter.com/mitchellh/status/319914935910027264\n[cooltext]: http://cooltext.com/\n"}]},"__N_SSG":true},"page":"/blog/categories/[tag]","query":{"tag":"cm"},"buildId":"jhtzWSA_9WoQI8qF29M1i","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>