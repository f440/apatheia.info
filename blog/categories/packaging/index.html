<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><title>tagged packaging - aptheia.info</title><link rel="alternate" type="application/rss+xml" title="apatheia.info" href="/atom.xml"/><meta name="next-head-count" content="4"/><link rel="preload" href="/_next/static/css/3c128f59c2ecef969dbc.css" as="style"/><link rel="stylesheet" href="/_next/static/css/3c128f59c2ecef969dbc.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-a40ef1678bae11e696dba45124eadd70.js"></script><script src="/_next/static/chunks/webpack-1a8a258926ecde76681b.js" defer=""></script><script src="/_next/static/chunks/framework-895f067827ebe11ffe45.js" defer=""></script><script src="/_next/static/chunks/main-a9acf05574b3448968f1.js" defer=""></script><script src="/_next/static/chunks/pages/_app-d96712b144c157b4cbfa.js" defer=""></script><script src="/_next/static/chunks/915-c287d7adb8a31cf4da35.js" defer=""></script><script src="/_next/static/chunks/pages/blog/categories/%5Btag%5D-c38c66d576a52b73b44b.js" defer=""></script><script src="/_next/static/PHKJ2Dzu0oDEBCrRGxDFE/_buildManifest.js" defer=""></script><script src="/_next/static/PHKJ2Dzu0oDEBCrRGxDFE/_ssgManifest.js" defer=""></script></head><body><div id="__next"><header><div id="site-title"><h1><a href="/">apatheia.info</a></h1></div><nav><ul><li><a href="/">Home</a></li><li><a href="/atom.xml">RSS</a></li></ul></nav></header><main><article><h1>Articles tagged &#x27;<!-- -->packaging<!-- -->&#x27;</h1><section style="margin-bottom:1em"><h2><a href="/blog/2013/05/07/create-ominibus-installer/">omnibus を使って オムニバスインストーラーを作成する</a></h2><span>2013.05.07</span> <span><a href="/blog/categories/packaging/">packaging</a> </span></section><section style="margin-bottom:1em"><h2><a href="/blog/2013/05/03/create-mesos-rpm-using-fpm/">fpm で Mesos の RPM を作るまで</a></h2><span>2013.05.03</span> <span><a href="/blog/categories/packaging/">packaging</a> </span><span><a href="/blog/categories/mesos/">mesos</a> </span></section></article></main><footer><ul><li>Link:</li><li><a href="https://twitter.com/f440">Twitter</a></li><li><a href="https://github.com/f440">Github</a></li><li><a href="https://pinbaord.in/u:f440">Pinbaord</a></li></ul></footer></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"tag":"packaging","posts":[{"localPath":"/home/f440/go/src/github.com/f440/f440.github.com/content/2013-05-07-create-ominibus-installer.markdown","path":"blog/2013/05/07/create-ominibus-installer","layout":"post","title":"omnibus を使って オムニバスインストーラーを作成する","createdAt":"2013-05-06T16:41:00.000Z","kind":"article","comments":true,"tags":["packaging"],"content":"\nChef のインストールは結構面倒くさかったんだけど、[オムニバスインストーラー][Install CHef]が出たことで状況はがらっと変わって、簡単に導入できるようになった。このオムニバスインストーラーの仕組みは汎用的に作られているので、他のツールでも適用できるという話。\n\n\u003c!-- more --\u003e\n\n## オムニバスインストーラーについて\n\nChef のオムニバスインストーラーを実行すると以下のようなディレクトリ構成でファイルが置かれる:\n\n- /opt/chef/bin/ ... Chef 関連のスクリプト\n- /opt/chef/embedded/ ... ruby インタプリタ、Chef とその他依存パッケージ\n- (/usr/bin/ ... /opt/chef/bin/ 以下のものがシンボリックリンクが配置される)\n\n以上の通り、`/opt/chef` の中に動作に必要なものがごっそり置かれる。アプリケーションレベルでプログラミングの処理系を持っちゃうというのはこれに限らずよく見る光景で、理由としてはパッケージ提供されていない最新版が使いたかったり、バージョンアップやライブラリインストールの影響範囲を限定させたかったりだと思う。\n\nここしばらくは手軽なパッケージ作成ツールとして[fpm][]がよく使われているけど、オムニバスインストーラーは[omnibus][]という「ビルドツール」＋「fpm ラッパー」といった感じのもので作られている。以下は実際に [omnibus][] を使ったインストーラー作成の手順についてまとめる。\n\n## パッケージ作成\n\n[statsd][] および [statsd][] を動かすために必要な Node.js を /opt/statsd にインストールする RPM, Deb パッケージの作成を行ってみる。\n\n### 環境\n\n- Macbook Air Mountain Lion\n- Ruby 2.0.0-p0\n- Vagrant 1.2.2\n\n### 手順\n\n    # omnibus のインストール\n    gem install omnibus\n\n    # 必要となる vagrant 用の plugin をインストール\n    vagrant plugin install vagrant-omnibus\n    vagrant plugin install vagrant-berkshelf\n\n    # プロジェクトディレクトリの作成(ディレクトリ名は `omnibus-プロジェクト` となる)\n    omnibus project statsd\n    cd omnibus-statsd\n\n    # プロジェクトディレクトリ内のファイルを適宜修正:\n        Berksfile\n          Berkshelf 用の設定。変更する必要無い。\n        Vagrantfile\n          Vagrant 用の設定。2013-06-07 現在だと CentOS 5, 6 Ubuntu 10.04, 11.04, 12.04 の設定が導入済み。\n        README.md\n        omnibus.rb.example\n          成果物を S3 上にキャッシュする場合などに利用。使わないなら気にしなくていい。\n        config/projects/statsd.rb\n          後述\n        config/software/*\n          後述\n        package-scripts/statsd/*\n          インストール時、アンインストール時などに実行したいスクリプトなど。\n\nこの中で、実際のビルドプロセスを定義するのは、config/projects/ 以下と config/software 以下になる。\n\n`config/projects/` はプロジェクトの設定を格納するディレクトリで、初期状態では statsd 用のプロジェクトファイル `config/projects/statsd.rb` が作られている。このファイルを修正していくことになる。\n\n    name \"statsd\"\n    maintainer \"f440\"\n    homepage \"https://github.com/f440/omnibus-statsd\"\n\n    install_path    \"/opt/statsd\"\n    build_version   \"0.6.0\"\n    build_iteration 1\n\n    dependency \"preparation\"\n    dependency \"node\"\n    dependency \"statsd\"\n\n    exclude \"\\.git*\"\n\nおおむね想像がつく名前だけど、dependency だけはよく分からないと思う。dependency で指定したものはプロジェクトを構成する software という扱いで、`config/software/` 以下でその設定を行っていく。\n\nsoftware の例を示す。典型的な例だと、指定した URL からダウンロードしてきたものを一時ディレクトリで展開して、`configure \u0026\u0026 make \u0026\u0026 make install` を実行、などだが今回の作業では Node.js のバイナリを展開して `/opt/embedded` 以下にコピーしているだけである。\n\n    name \"node\"\n    version \"0.10.5\"\n\n    source :url =\u003e \"http://nodejs.org/dist/v0.10.5/node-v0.10.5-linux-x64.tar.gz\",\n           :md5 =\u003e \"fb65723d395c559393201dd41e0eb275\"\n\n    relative_path \"node-v0.10.5-linux-x64\"\n\n    build do\n      command \"rsync -av . #{install_dir}/embedded/\"\n    end\n\n\n必要となる software の設定を全部そろえたらビルドを実行する。マシンの起動、Chef のインストール、omnibus の Cookbook 実行、ビルド環境構築、ビルド実行、パッケージ作成 といったことが行われることになるため、初回はかなり待つことになる。\n\n    vagrant up\n    (vagrant up centos-6 など、直接マシンを指定してもいい)\n    (もし Linux 上で作業しているのであれば、omnibus build project statsd で直接パッケージ作成を開始出来る)\n\n問題なければ、pkg/ 以下に statsd-0.6.0-1.el6.x86_64.rpm, statsd_0.6.0-1.ubuntu.12.04_amd64.deb といったファイルが出来る。\n\n## まとめ\n\nやっていることは [fpm][] でパッケージを作っているだけなんだけど、[Vagrant][] x [Berkshelf][] x [Chef][] のコンビネーションのおかげで、パッケージとそのパッケージを作るための環境が簡単に手に入るのはとてもいい。複数環境のパッケージを作る予定がなくっても、最初から[omnibus][]上でパッケージを作れるようにしておくと運用が楽そう。\n\n## 備考\n\n似たようなツールとして、[bunchr][] が存在する。\n\n## 参考\n\n- [Statsd]\n- [Install Chef]\n- [omnibus]\n- [bunchr]\n- [fpm]\n- [Vagrant]\n- [Berkshelf]\n\n[Statsd]: https://github.com/etsy/statsd\n[Install Chef]: http://www.opscode.com/chef/install/\n[omnibus]: https://github.com/opscode/omnibus-ruby\n[Chef]: http://www.opscode.com/chef/\n[Berkshelf]: http://berkshelf.com/\n[Vagrant]: http://www.vagrantup.com/\n[bunchr]: https://github.com/joemiller/bunchr\n[fpm]: https://github.com/jordansissel/fpm\n[sensu]: https://github.com/sensu\n"},{"localPath":"/home/f440/go/src/github.com/f440/f440.github.com/content/2013-05-03-create-mesos-rpm-using-fpm.markdown","path":"blog/2013/05/03/create-mesos-rpm-using-fpm","layout":"post","title":"fpm で Mesos の RPM を作るまで","createdAt":"2013-05-03T08:24:00.000Z","kind":"article","comments":true,"tags":["packaging","mesos"],"content":"\n[Mesos] をインストールするとき各マシンでビルドはしんどいので、[fpm] で Mesos の RPM を作ってインストールしている。ビルドからパッケージ作成までの作業ログを残しておく。\n\n\u003c!-- more --\u003e\n\n- [fpm] は Ruby の gem や Node.js の npm などのプログラミング言語のライブラリ、あるいは直接ディレクトリから RPM やら Deb やらのパッケージを作成するソフトウェア。\n- [Mesos] はクラスタ構成のリソースをよしなに管理するソフトウェア。\n  - 今回の話では具体的な使い方までは触れない\n\n## 手順\n\n作業環境は CentOS 6.4 x86\\_64。\n\n Ruby をインストール。\n\n    sudo yum install ruby.x86_64 rubygems ruby-devel.x86_64 rpm-build.x86_64\n\nfpm をインストール。\n\n    sudo gem install fpm --no-rdoc --no-ri\n\nMesos のソースをダウンロード、展開。\n\n    curl -LO http://ftp.meisei-u.ac.jp/mirror/apache/dist/incubator/mesos/mesos-0.10.0-incubating/mesos-0.10.0-incubating.tar.gz\n    tar xf mesos-0.10.0-incubating.tar.gz\n    cd mesos-0.10.0\n\nMesos のビルドに必要なパッケージをインストール。\n\n    sudo yum install gcc-c++.x86_64 patch.x86_64 python-devel.x86_64 \\\n      cppunit-devel.x86_64 java-1.6.0-openjdk-devel.x86_64\n\nビルド。今回は、configure のオプションで Redhat っぽい配置を指定している。`/opt/mesos` とか `/usr/local/mesos` に全部まとめたければ --prefix を使うなど、このあたりはお好みで。\n`make install` 時には書き込み可能な場所を DESTDIR で指定。説明中では、`/tmp/mesos` を利用している。\n\n    JAVA_HOME=/etc/alternatives/java_sdk ./configure \\\n      --bindir=/usr/bin --sbindir=/usr/sbin --libexecdir=/usr/libexec \\\n      --localstatedir=/var --libdir=/usr/lib64 --includedir=/usr/include \\\n      --datarootdir=/usr/share\n    make\n    make install DESTDIR=/tmp/mesos\n\nfpm でパッケージを作成。詳細は fpm --help を参照。注意点としては、`--description` は RPM のメタ情報 `description`, `summary` で兼用されるので、あまり長い情報を入れると `yum search` とかがごちゃごちゃすることになる。適度に切り詰めた方がいい。\n\n    fpm -s dir -t rpm \\\n      -v 0.10.0 \\\n      -n mesos \\\n      -C /tmp/mesos \\\n      -a x86_64 \\\n      --license \"ASL 2.0\" \\\n      --url \"http://incubator.apache.org/mesos/\" \\\n      --description \"Dynamic resource sharing for clusters\" \\\n      -d python-devel \\\n      -d java-1.6.0-openjdk-devel \\\n      .\n\nRPM ファイルのメタ情報やファイル一覧をチェック。\n\n    rpm -qpi mesos-0.10.0-1.x86_64.rpm\n    rpm -qpl mesos-0.10.0-1.x86_64.rpm\n\nあとは、できあがった RPM ファイルを他のマシンに持っていってインストール。\n\n    sudo yum install ./mesos-0.10.0-1.x86_64.rpm\n\n[Mesos]: http://incubator.apache.org/mesos/\n[fpm]: https://github.com/jordansissel/fpm\n"}]},"__N_SSG":true},"page":"/blog/categories/[tag]","query":{"tag":"packaging"},"buildId":"PHKJ2Dzu0oDEBCrRGxDFE","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>