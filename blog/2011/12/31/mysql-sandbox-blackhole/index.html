<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><title>MySQL::Sandboxで環境を作ってBLACKHOLEエンジンを試す - aptheia.info</title><link rel="alternate" type="application/rss+xml" title="apatheia.info" href="/atom.xml"/><meta name="next-head-count" content="4"/><link rel="preload" href="/_next/static/css/c513e7236c8bf720ec88.css" as="style"/><link rel="stylesheet" href="/_next/static/css/c513e7236c8bf720ec88.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-a40ef1678bae11e696dba45124eadd70.js"></script><script src="/_next/static/chunks/webpack-1a8a258926ecde76681b.js" defer=""></script><script src="/_next/static/chunks/framework-895f067827ebe11ffe45.js" defer=""></script><script src="/_next/static/chunks/main-a9acf05574b3448968f1.js" defer=""></script><script src="/_next/static/chunks/pages/_app-e9aa21e07402b3aa54f7.js" defer=""></script><script src="/_next/static/chunks/915-c287d7adb8a31cf4da35.js" defer=""></script><script src="/_next/static/chunks/pages/blog/%5B...slug%5D-c134caf83809c687960e.js" defer=""></script><script src="/_next/static/EL7aLKI83tZi_FFCsIrzy/_buildManifest.js" defer=""></script><script src="/_next/static/EL7aLKI83tZi_FFCsIrzy/_ssgManifest.js" defer=""></script></head><body><div id="__next"><header><div id="site-title"><h1><a href="/">apatheia.info</a></h1></div><nav><ul><li><a href="/">Home</a></li><li><a href="/atom.xml">RSS</a></li></ul></nav></header><main><article><h1>MySQL::Sandboxで環境を作ってBLACKHOLEエンジンを試す</h1><p id="article-info">Published on <!-- -->2011.12.31<!-- --> <span><a href="/blog/categories/mysql/">mysql</a> </span></p><div><p>ちょっとMySQLのBLACKHOLEエンジン使って調べたいことがあったんだけど、
<a href="http://mysqlsandbox.net/">MySQL::Sandbox</a> 使うとレプリケーション環境が簡単に構築できて便利。</p>
<!-- more -->
<p>以下は、MySQL::SandboxのセットアップからBLACKHOLEエンジン使うところまでの記録。</p>
<h3>前提</h3>
<ul>
<li>確認した環境は Debian 6.0.3, perl v5.12.3</li>
<li>cpanm &#x26; perlbrew インストール済み（<code>cpan</code>コマンドでも問題無いはず）</li>
<li>MySQL 5.5 はサーバーを起動するためにlibaio1が必要なので、あらかじめパッケージをインストールしておく</li>
</ul>
<h3>手順</h3>
<h4>インストール</h4>
<p><code>cpanm</code> でMySQL::Sandbox をインストール。</p>
<pre><code>$ cpanm MySQL::Sandbox
</code></pre>
<p>これで make_sandbox などのコマンド群がインストールされる。</p>
<p>データファイルは以下のようなファイル構成を取る</p>
<ul>
<li>$HOME/opt/mysql 以下のサブディレクトリにサーバーを設置 (環境変数 SANDBOX_BINARY で変更可能)</li>
<li>$HOME/sandboxes 以下のサブディレクトリにMySQLのデータや起動スクリプトを設置 (環境変数 SANDBOX_HOME で変更可能)</li>
</ul>
<h4>サーバーセットアップ</h4>
<p>サーバーを起動してみる。</p>
<pre><code># 使用するディレクトリ設定
$ export SANDBOX_BINARY=$HOME/opt/mysql
$ export SANDBOX_HOME=$HOME/opt/sandboxes
# ソース取得
$ cd SANDBOX_HOME
$ curl -L -o mysql-5.5.19-linux2.6-x86_64.tar.gz http://www-jp.mysql.com/get/Downloads/MySQL-5.5/mysql-5.5.19-linux2.6-x86_64.tar.gz/from/http://ftp.jaist.ac.jp/pub/mysql/
# Sandbox 作成
$ make_sandbox $SANDBOX_BINARY/mysql-5.5.19-linux2.6-x86_64.tar.gz
</code></pre>
<p>これで$SANDBOX_BINARY/5.5.19 にサーバーが、また $SANDBOX_HOME/msb_5_5_19 以下にインスタンスが作成される。</p>
<p>この時点で起動出来ているはずなので、接続してみる。以下で mysql クライアントが起動するはず。</p>
<pre><code>$ $SANDBOX_HOME/msb_5_5_19/use
</code></pre>
<p><code>use</code>以外には、<code>start</code>, <code>stop</code>, <code>status</code> などの名前から動作が推測できそうなコマンド群がある。$SANDBOX_HOMEには複数のサンドボックスを操作するコマンド <code>use_all</code>, <code>start_all</code>, <code>stop_all</code> などがある。</p>
<pre><code>$ make_replication_sandbox 5.5.19 
# 第二引数はtar.gzまでのパスでもいいが、一度展開されたらバージョン番号指定でもいい。make_sandboxも同様
</code></pre>
<p>以上で、 master, node1, node2 というサーバーが起動する。node1, node2 は masterを参照したレプリケーション構成となる。デフォルトでノードは2台だが、<code>--how_many_nodes</code> オプションで台数は変更可能。</p>
<p>同様に[Circular recplication](http://dev.mysql.com/doc/refman/5.1/ja/replication-
topology-circular.html)(日本語訳だとなんになるんだろう)も簡単に作れる。マスター/マスターレプリケーションはCircular replication が2台のみの構成だった場合に同じ。</p>
<pre><code>$ make_replication_sandbox --circular=4 5.5.19
</code></pre>
<p>これで node1 -> node2, node2 -> nod3, node3 -> node4, node4 -> node1 という循環関係のレプリケーションが作れる。</p>
<p>使い終わったら止めておこう。</p>
<pre><code>$ $SANDBOX_HOME/stop_all
</code></pre>
<h3>BLACKHOLEエンジンを試す</h3>
<p>準備ができたので、<a href="http://dev.mysql.com/doc/refman/5.1/ja/blackhole-storage-engine.html">BLACKHOLEエンジン</a>を使ってみる。BLACKHOLEエンジンはバイナリログは記録するが、データは残さないストレージエンジンのこと。</p>
<p>まずは、サンドボックス作成</p>
<p>$ make_replication_sandbox --circular=3 5.5.19</p>
<p>デフォルトストレージエンジンをnode1, node3はInnoDB、node2 はBLACKHOLEに変更</p>
<pre><code>$ echo default_storage_engine=InnoDB >> $SANDBOX_HOME/rcsandbox_5_5_19/node1/my.sandbox.cnf
$ echo default_storage_engine=BLACKHOLE >> $SANDBOX_HOME/rcsandbox_5_5_19/node2/my.sandbox.cnf
$ echo default_storage_engine=InnoDB >> $SANDBOX_HOME/rcsandbox_5_5_19/node3/my.sandbox.cnf
$ $SANDBOX_HOME/rcsandbox_5_5_19/restart_all
</code></pre>
<p>node2, node3 のレプリケーションだけ再開して、node1 -> node2 -> node3 の2階層スレーブにする。</p>
<pre><code>$ $SANDBOX_HOME/rcsandbox_5_5_19/node2/use -e start slave
$ $SANDBOX_HOME/rcsandbox_5_5_19/node3/use -e start slave
</code></pre>
<p>実験のための構成が完成した。ここで、node1 にデータを流し込んだとき、node2 にはデータが残らなくて、node3 にデータが出来たら成功。</p>
<p>サンプルデータには、[Sample database with test suite](https://launchpad.net/test-
db/)を利用する。</p>
<pre><code>$ curl -LO [http://launchpad.net/test-db/employees-db-1/1.0.6/+download/employees_db-full-1.0.6.tar.bz2](http://launchpad.net/test-db/employees-db-1/1.0.6/+download/employees_db-full-1.0.6.tar.bz2)
$ tar xf employees_db-full-1.0.6.tar.bz2
$ cd employees_db
# InnoDB が決めうちで設定されているので、コメントアウト
$ sed -i -re s/^\s+(set storage_engine = InnoDB;)/-- \1/ *.sql
# 取り込み
$ $SANDBOX_HOME/rcsandbox_5_5_19/node1/use  -t &#x3C; ./employees.sql
</code></pre>
<p>結果</p>
<pre><code>$ cd $SANDBOX_HOME
$ du -sh rcsandbox_5_5_19/node?/data/ibdata1
219M    rcsandbox_5_5_19/node1/data/ibdata1
18M     rcsandbox_5_5_19/node2/data/ibdata1
219M    rcsandbox_5_5_19/node3/data/ibdata1
</code></pre>
<p>node2 だけデータファイルがふくらまない。</p>
<pre><code>$ ls -l rcsandbox_5_5_19/node2/data/
合計 357652
drwx------ 2 f440 f440      4096 2011-12-31 17:15 employees/
-rw-rw---- 1 f440 f440   5242880 2011-12-31 17:14 ib_logfile0
-rw-rw---- 1 f440 f440   5242880 2011-12-31 17:11 ib_logfile1
-rw-rw---- 1 f440 f440  18874368 2011-12-31 17:14 ibdata1
-rw-rw---- 1 f440 f440        88 2011-12-31 17:16 master.info
-rw-rw---- 1 f440 f440      5925 2011-12-31 17:14 msandbox.err
drwx------ 2 f440 f440      4096 2011-12-31 17:11 mysql/
-rw-rw---- 1 f440 f440      6273 2011-12-31 17:14 mysql-bin.000001
-rw-rw---- 1 f440 f440 168403385 2011-12-31 17:16 mysql-bin.000002
-rw-rw---- 1 f440 f440        38 2011-12-31 17:14 mysql-bin.index
-rw-rw---- 1 f440 f440       315 2011-12-31 17:14 mysql_sandbox15902-relay-bin.000005
-rw-rw---- 1 f440 f440 168399499 2011-12-31 17:16 mysql_sandbox15902-relay-bin.000006
-rw-rw---- 1 f440 f440        76 2011-12-31 17:14 mysql_sandbox15902-relay-bin.index
-rw-rw---- 1 f440 f440         5 2011-12-31 17:14 mysql_sandbox15902.pid
drwx------ 2 f440 f440      4096 2011-12-31 17:11 performance_schema/
-rw-rw---- 1 f440 f440        75 2011-12-31 17:16 relay-log.info
drwx------ 2 f440 f440      4096 2011-12-31 17:11 test/
</code></pre>
<p>node2 のバイナリログ、リレーログはちゃんと出来ているので、BLACKHOLEエンジンの適用を確認できた。</p>
<h3>メモ</h3>
<ul>
<li><code>$SANDBOX_HOME/clear_all</code> でデータ消せるの便利。</li>
<li>MySQL::Sandbox 3.0.19 からは、<a href="http://mysqlsandbox.net/news.html">Percona や Maria DB などの派生DBも扱える</a>みたい。いろいろなバージョンで試すことが多いのでうれしい。</li>
</ul>
</div></article></main><footer><ul><li>Link:</li><li><a href="https://twitter.com/f440">Twitter</a></li><li><a href="https://github.com/f440">Github</a></li><li><a href="https://pinbaord.in/u:f440">Pinbaord</a></li></ul></footer></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"localPath":"/home/f440/go/src/github.com/f440/f440.github.com/content/2011-12-31-mysql-sandbox-blackhole.markdown","path":"2011/12/31/mysql-sandbox-blackhole","layout":"post","title":"MySQL::Sandboxで環境を作ってBLACKHOLEエンジンを試す","createdAt":"2011-12-30T15:00:00.000Z","kind":"article","comments":true,"tags":["mysql"],"content":"\u003cp\u003eちょっとMySQLのBLACKHOLEエンジン使って調べたいことがあったんだけど、\n\u003ca href=\"http://mysqlsandbox.net/\"\u003eMySQL::Sandbox\u003c/a\u003e 使うとレプリケーション環境が簡単に構築できて便利。\u003c/p\u003e\n\u003c!-- more --\u003e\n\u003cp\u003e以下は、MySQL::SandboxのセットアップからBLACKHOLEエンジン使うところまでの記録。\u003c/p\u003e\n\u003ch3\u003e前提\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e確認した環境は Debian 6.0.3, perl v5.12.3\u003c/li\u003e\n\u003cli\u003ecpanm \u0026#x26; perlbrew インストール済み（\u003ccode\u003ecpan\u003c/code\u003eコマンドでも問題無いはず）\u003c/li\u003e\n\u003cli\u003eMySQL 5.5 はサーバーを起動するためにlibaio1が必要なので、あらかじめパッケージをインストールしておく\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3\u003e手順\u003c/h3\u003e\n\u003ch4\u003eインストール\u003c/h4\u003e\n\u003cp\u003e\u003ccode\u003ecpanm\u003c/code\u003e でMySQL::Sandbox をインストール。\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e$ cpanm MySQL::Sandbox\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eこれで make_sandbox などのコマンド群がインストールされる。\u003c/p\u003e\n\u003cp\u003eデータファイルは以下のようなファイル構成を取る\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e$HOME/opt/mysql 以下のサブディレクトリにサーバーを設置 (環境変数 SANDBOX_BINARY で変更可能)\u003c/li\u003e\n\u003cli\u003e$HOME/sandboxes 以下のサブディレクトリにMySQLのデータや起動スクリプトを設置 (環境変数 SANDBOX_HOME で変更可能)\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch4\u003eサーバーセットアップ\u003c/h4\u003e\n\u003cp\u003eサーバーを起動してみる。\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e# 使用するディレクトリ設定\n$ export SANDBOX_BINARY=$HOME/opt/mysql\n$ export SANDBOX_HOME=$HOME/opt/sandboxes\n# ソース取得\n$ cd SANDBOX_HOME\n$ curl -L -o mysql-5.5.19-linux2.6-x86_64.tar.gz http://www-jp.mysql.com/get/Downloads/MySQL-5.5/mysql-5.5.19-linux2.6-x86_64.tar.gz/from/http://ftp.jaist.ac.jp/pub/mysql/\n# Sandbox 作成\n$ make_sandbox $SANDBOX_BINARY/mysql-5.5.19-linux2.6-x86_64.tar.gz\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eこれで$SANDBOX_BINARY/5.5.19 にサーバーが、また $SANDBOX_HOME/msb_5_5_19 以下にインスタンスが作成される。\u003c/p\u003e\n\u003cp\u003eこの時点で起動出来ているはずなので、接続してみる。以下で mysql クライアントが起動するはず。\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e$ $SANDBOX_HOME/msb_5_5_19/use\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\u003ccode\u003euse\u003c/code\u003e以外には、\u003ccode\u003estart\u003c/code\u003e, \u003ccode\u003estop\u003c/code\u003e, \u003ccode\u003estatus\u003c/code\u003e などの名前から動作が推測できそうなコマンド群がある。$SANDBOX_HOMEには複数のサンドボックスを操作するコマンド \u003ccode\u003euse_all\u003c/code\u003e, \u003ccode\u003estart_all\u003c/code\u003e, \u003ccode\u003estop_all\u003c/code\u003e などがある。\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e$ make_replication_sandbox 5.5.19 \n# 第二引数はtar.gzまでのパスでもいいが、一度展開されたらバージョン番号指定でもいい。make_sandboxも同様\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e以上で、 master, node1, node2 というサーバーが起動する。node1, node2 は masterを参照したレプリケーション構成となる。デフォルトでノードは2台だが、\u003ccode\u003e--how_many_nodes\u003c/code\u003e オプションで台数は変更可能。\u003c/p\u003e\n\u003cp\u003e同様に[Circular recplication](http://dev.mysql.com/doc/refman/5.1/ja/replication-\ntopology-circular.html)(日本語訳だとなんになるんだろう)も簡単に作れる。マスター/マスターレプリケーションはCircular replication が2台のみの構成だった場合に同じ。\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e$ make_replication_sandbox --circular=4 5.5.19\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eこれで node1 -\u003e node2, node2 -\u003e nod3, node3 -\u003e node4, node4 -\u003e node1 という循環関係のレプリケーションが作れる。\u003c/p\u003e\n\u003cp\u003e使い終わったら止めておこう。\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e$ $SANDBOX_HOME/stop_all\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch3\u003eBLACKHOLEエンジンを試す\u003c/h3\u003e\n\u003cp\u003e準備ができたので、\u003ca href=\"http://dev.mysql.com/doc/refman/5.1/ja/blackhole-storage-engine.html\"\u003eBLACKHOLEエンジン\u003c/a\u003eを使ってみる。BLACKHOLEエンジンはバイナリログは記録するが、データは残さないストレージエンジンのこと。\u003c/p\u003e\n\u003cp\u003eまずは、サンドボックス作成\u003c/p\u003e\n\u003cp\u003e$ make_replication_sandbox --circular=3 5.5.19\u003c/p\u003e\n\u003cp\u003eデフォルトストレージエンジンをnode1, node3はInnoDB、node2 はBLACKHOLEに変更\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e$ echo default_storage_engine=InnoDB \u003e\u003e $SANDBOX_HOME/rcsandbox_5_5_19/node1/my.sandbox.cnf\n$ echo default_storage_engine=BLACKHOLE \u003e\u003e $SANDBOX_HOME/rcsandbox_5_5_19/node2/my.sandbox.cnf\n$ echo default_storage_engine=InnoDB \u003e\u003e $SANDBOX_HOME/rcsandbox_5_5_19/node3/my.sandbox.cnf\n$ $SANDBOX_HOME/rcsandbox_5_5_19/restart_all\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003enode2, node3 のレプリケーションだけ再開して、node1 -\u003e node2 -\u003e node3 の2階層スレーブにする。\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e$ $SANDBOX_HOME/rcsandbox_5_5_19/node2/use -e start slave\n$ $SANDBOX_HOME/rcsandbox_5_5_19/node3/use -e start slave\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e実験のための構成が完成した。ここで、node1 にデータを流し込んだとき、node2 にはデータが残らなくて、node3 にデータが出来たら成功。\u003c/p\u003e\n\u003cp\u003eサンプルデータには、[Sample database with test suite](https://launchpad.net/test-\ndb/)を利用する。\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e$ curl -LO [http://launchpad.net/test-db/employees-db-1/1.0.6/+download/employees_db-full-1.0.6.tar.bz2](http://launchpad.net/test-db/employees-db-1/1.0.6/+download/employees_db-full-1.0.6.tar.bz2)\n$ tar xf employees_db-full-1.0.6.tar.bz2\n$ cd employees_db\n# InnoDB が決めうちで設定されているので、コメントアウト\n$ sed -i -re s/^\\s+(set storage_engine = InnoDB;)/-- \\1/ *.sql\n# 取り込み\n$ $SANDBOX_HOME/rcsandbox_5_5_19/node1/use  -t \u0026#x3C; ./employees.sql\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e結果\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e$ cd $SANDBOX_HOME\n$ du -sh rcsandbox_5_5_19/node?/data/ibdata1\n219M    rcsandbox_5_5_19/node1/data/ibdata1\n18M     rcsandbox_5_5_19/node2/data/ibdata1\n219M    rcsandbox_5_5_19/node3/data/ibdata1\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003enode2 だけデータファイルがふくらまない。\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e$ ls -l rcsandbox_5_5_19/node2/data/\n合計 357652\ndrwx------ 2 f440 f440      4096 2011-12-31 17:15 employees/\n-rw-rw---- 1 f440 f440   5242880 2011-12-31 17:14 ib_logfile0\n-rw-rw---- 1 f440 f440   5242880 2011-12-31 17:11 ib_logfile1\n-rw-rw---- 1 f440 f440  18874368 2011-12-31 17:14 ibdata1\n-rw-rw---- 1 f440 f440        88 2011-12-31 17:16 master.info\n-rw-rw---- 1 f440 f440      5925 2011-12-31 17:14 msandbox.err\ndrwx------ 2 f440 f440      4096 2011-12-31 17:11 mysql/\n-rw-rw---- 1 f440 f440      6273 2011-12-31 17:14 mysql-bin.000001\n-rw-rw---- 1 f440 f440 168403385 2011-12-31 17:16 mysql-bin.000002\n-rw-rw---- 1 f440 f440        38 2011-12-31 17:14 mysql-bin.index\n-rw-rw---- 1 f440 f440       315 2011-12-31 17:14 mysql_sandbox15902-relay-bin.000005\n-rw-rw---- 1 f440 f440 168399499 2011-12-31 17:16 mysql_sandbox15902-relay-bin.000006\n-rw-rw---- 1 f440 f440        76 2011-12-31 17:14 mysql_sandbox15902-relay-bin.index\n-rw-rw---- 1 f440 f440         5 2011-12-31 17:14 mysql_sandbox15902.pid\ndrwx------ 2 f440 f440      4096 2011-12-31 17:11 performance_schema/\n-rw-rw---- 1 f440 f440        75 2011-12-31 17:16 relay-log.info\ndrwx------ 2 f440 f440      4096 2011-12-31 17:11 test/\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003enode2 のバイナリログ、リレーログはちゃんと出来ているので、BLACKHOLEエンジンの適用を確認できた。\u003c/p\u003e\n\u003ch3\u003eメモ\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ccode\u003e$SANDBOX_HOME/clear_all\u003c/code\u003e でデータ消せるの便利。\u003c/li\u003e\n\u003cli\u003eMySQL::Sandbox 3.0.19 からは、\u003ca href=\"http://mysqlsandbox.net/news.html\"\u003ePercona や Maria DB などの派生DBも扱える\u003c/a\u003eみたい。いろいろなバージョンで試すことが多いのでうれしい。\u003c/li\u003e\n\u003c/ul\u003e\n"}},"__N_SSG":true},"page":"/blog/[...slug]","query":{"slug":["2011","12","31","mysql-sandbox-blackhole"]},"buildId":"EL7aLKI83tZi_FFCsIrzy","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>